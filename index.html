<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gingerbread House Contest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #8B0000; /* Deep Christmas Red */
            overflow-x: hidden;
        }
        
        h1, h2, .festive-font {
            font-family: 'Mountains of Christmas', cursive;
        }

        /* Snow Animation */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial;
            text-shadow: 0 0 1px #000;
            position: fixed;
            top: -10%;
            z-index: 9999;
            user-select: none;
            cursor: default;
            animation-name: snowflakes-fall, snowflakes-shake;
            animation-duration: 10s, 3s;
            animation-timing-function: linear, ease-in-out;
            animation-iteration-count: infinite, infinite;
            animation-play-state: running, running;
        }

        @keyframes snowflakes-fall {
            0% { top: -10%; }
            100% { top: 100%; }
        }

        @keyframes snowflakes-shake {
            0% { transform: translateX(0px); }
            50% { transform: translateX(80px); }
            100% { transform: translateX(0px); }
        }

        .snowflake:nth-of-type(0) { left: 1%; animation-delay: 0s, 0s; }
        .snowflake:nth-of-type(1) { left: 10%; animation-delay: 1s, 1s; }
        .snowflake:nth-of-type(2) { left: 20%; animation-delay: 6s, .5s; }
        .snowflake:nth-of-type(3) { left: 30%; animation-delay: 4s, 2s; }
        .snowflake:nth-of-type(4) { left: 40%; animation-delay: 2s, 2s; }
        .snowflake:nth-of-type(5) { left: 50%; animation-delay: 8s, 3s; }
        .snowflake:nth-of-type(6) { left: 60%; animation-delay: 6s, 2s; }
        .snowflake:nth-of-type(7) { left: 70%; animation-delay: 2.5s, 1s; }
        .snowflake:nth-of-type(8) { left: 80%; animation-delay: 1s, 0s; }
        .snowflake:nth-of-type(9) { left: 90%; animation-delay: 3s, 1.5s; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-vote {
            transition: all 0.2s ease;
        }
        .btn-vote:active {
            transform: scale(0.95);
        }
        .btn-disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }
        
        /* Gold and Silver Text Gradients */
        .text-gold {
            background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .text-silver {
            background: linear-gradient(to right, #757575, #E8E8E8, #9E9E9E, #ffffff, #595959);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* Podium Animation */
        #winners-podium {
            transition: all 1s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        #winners-podium.show {
            max-height: 1000px;
            opacity: 1;
            margin-bottom: 3rem;
        }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- Falling Snow -->
    <div class="snowflakes" aria-hidden="true">
        <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div>
        <div class="snowflake">‚ùÖ</div><div class="snowflake">‚ùÜ</div>
    </div>

    <!-- Header -->
    <header class="text-center pt-8 pb-6 px-4 text-white relative z-10">
        <h1 class="text-5xl md:text-6xl font-bold mb-2 drop-shadow-md">Gingerbread Contest</h1>
        <p id="status-text" class="text-xl opacity-90 font-semibold">Vote for your favorite holiday masterpiece!</p>
        <div id="timer" class="text-yellow-200 font-bold mt-2 text-lg"></div>
        
        <div id="voted-banner" class="hidden mt-4 bg-green-600 text-white px-4 py-2 rounded-full inline-block shadow-lg animate-bounce">
            <i class="fas fa-check-circle mr-2"></i> You have cast your vote!
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 relative z-10 max-w-6xl">
        
        <!-- WINNERS PODIUM (Hidden until 8pm) -->
        <div id="winners-podium" class="w-full">
            <div class="glass-panel p-8 text-center bg-gradient-to-b from-white to-gray-100 border-4 border-yellow-400 mb-8 relative">
                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-2 rounded-full font-bold shadow-lg border-2 border-white">
                    üèÜ OFFICIAL RESULTS üèÜ
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6 items-end">
                    <!-- 2nd Place (Left) -->
                    <div class="order-2 md:order-1 transform scale-90 opacity-90">
                        <div class="text-4xl mb-2">ü•à</div>
                        <h3 class="text-2xl font-bold text-gray-600">2nd Place</h3>
                        <div id="winner-2-img" class="h-40 w-full bg-gray-300 rounded-lg mb-2 bg-cover bg-center shadow-inner"></div>
                        <h2 id="winner-2-name" class="text-xl font-bold text-gray-800">Calculating...</h2>
                        <p id="winner-2-votes" class="text-gray-500 font-bold">0 Votes</p>
                    </div>

                    <!-- 1st Place (Right/Center) -->
                    <div class="order-1 md:order-2 transform scale-105 z-10">
                        <div class="text-6xl mb-2 animate-bounce">üëë</div>
                        <h3 class="text-3xl font-bold text-gold">1st Place</h3>
                        <div id="winner-1-img" class="h-56 w-full bg-gray-300 rounded-lg mb-4 bg-cover bg-center shadow-xl border-4 border-yellow-300"></div>
                        <h2 id="winner-1-name" class="text-3xl font-extrabold text-gray-900 festive-font">Calculating...</h2>
                        <p id="winner-1-votes" class="text-xl text-red-600 font-bold">0 Votes</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- House Grid -->
        <div id="house-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Cards will be injected here -->
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center text-white/70 mt-12 pb-6 relative z-10 text-sm">
        <p>Made with holiday magic üéÑ</p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        
        // !!! URGENT FIX FOR TONIGHT !!!
        // Using explicit local time construction to avoid UTC/Timezone mixups.
        // new Date(Year, Month (0-11), Day, Hour (0-23), Min, Sec)
        // Month 11 is December.
        // This sets the deadline to 8:00:00 PM on Dec 27, 2025 (Local Device Time)
        const VOTING_DEADLINE = new Date(2025, 11, 27, 20, 0, 0); 
        
        const firebaseConfig = {
          apiKey: "AIzaSyA1BmHBdRPSDQaimlE1Q7k5czsBntj3r-Q",
          authDomain: "gingerbread-93c23.firebaseapp.com",
          projectId: "gingerbread-93c23",
          storageBucket: "gingerbread-93c23.firebasestorage.app",
          messagingSenderId: "844960983142",
          appId: "1:844960983142:web:087c95208340139113e5a7",
          measurementId: "G-SBSNKYMGKB"
        };

        // --- IMAGE DATA (11 HOUSES) ---
        const housesData = [
            { id: 1, name: "The Candy Cottage", img: "https://upforwardcommunity.github.io/GingerbreadContest/house1.jpg" },
            { id: 2, name: "Frosty's Fortress", img: "https://placehold.co/600x400/8b4513/FFF?text=House+2" },
            { id: 3, name: "Gumdrop Manor", img: "https://placehold.co/600x400/8b4513/FFF?text=House+3" },
            { id: 4, name: "Peppermint Palace", img: "https://placehold.co/600x400/8b4513/FFF?text=House+4" },
            { id: 5, name: "Santa's Workshop", img: "https://placehold.co/600x400/8b4513/FFF?text=House+5" },
            { id: 6, name: "Sugarplum Chalet", img: "https://placehold.co/600x400/8b4513/FFF?text=House+6" },
            { id: 7, name: "The Icing Igloo", img: "https://placehold.co/600x400/8b4513/FFF?text=House+7" },
            { id: 8, name: "Cookie Castle", img: "https://placehold.co/600x400/8b4513/FFF?text=House+8" },
            { id: 9, name: "Reindeer Barn", img: "https://placehold.co/600x400/8b4513/FFF?text=House+9" },
            { id: 10, name: "Elven Estate", img: "https://placehold.co/600x400/8b4513/FFF?text=House+10" },
            { id: 11, name: "Snowflake Station", img: "https://placehold.co/600x400/8b4513/FFF?text=House+11" }
        ];

        // --- FIREBASE INIT ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let currentUser = null;
        let hasVotedLocal = localStorage.getItem('gingerbread_voted_2025');
        let currentVotes = {}; 
        let isVotingClosed = false;

        // --- DOM ELEMENTS ---
        const houseGrid = document.getElementById('house-grid');
        const votedBanner = document.getElementById('voted-banner');
        const winnersPodium = document.getElementById('winners-podium');
        const statusText = document.getElementById('status-text');
        const timerDiv = document.getElementById('timer');

        // --- INITIAL RENDER ---
        renderHouses({}); 
        
        // Start Timer Check
        setInterval(checkTime, 1000);
        checkTime(); // Run once immediately

        // --- AUTH & STARTUP ---
        async function initApp() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                setupRealtimeListener();
                checkLocalVoteStatus();
            }
        });

        initApp();

        // --- TIME CHECKER ---
        function checkTime() {
            const now = new Date();
            
            if (now >= VOTING_DEADLINE) {
                if (!isVotingClosed) {
                    // This block runs once when deadline hits
                    isVotingClosed = true;
                    statusText.innerText = "Voting is officially closed!";
                    timerDiv.innerText = "";
                    revealWinners();
                    disableAllVoting();
                }
            } else {
                // Update countdown
                const diff = VOTING_DEADLINE - now;
                
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                let timeString = "";
                if (hours > 0) timeString += `${hours}h `;
                timeString += `${minutes}m ${seconds}s`;
                
                timerDiv.innerText = `Voting closes in: ${timeString}`;
            }
        }

        // --- FIRESTORE LISTENER ---
        function setupRealtimeListener() {
            const votesCollection = collection(db, 'gingerbread_votes');

            onSnapshot(votesCollection, (snapshot) => {
                const newVotes = {};
                snapshot.forEach(doc => {
                    newVotes[doc.id] = doc.data().count || 0;
                });
                currentVotes = newVotes;
                updateVoteCounts();
                
                // If voting is closed, we must keep updating the podium live!
                if (isVotingClosed) {
                    revealWinners();
                }
            }, (error) => {
                console.error("Snapshot Error:", error);
            });
        }

        // --- RENDERING ---
        function renderHouses(votesMap) {
            houseGrid.innerHTML = '';
            
            housesData.forEach(house => {
                const voteCount = votesMap[`house_${house.id}`] || 0;
                
                // Card Container
                const card = document.createElement('div');
                card.className = "glass-panel overflow-hidden transform transition duration-300 hover:-translate-y-1 hover:shadow-xl relative";
                
                // Inner HTML
                card.innerHTML = `
                    <div class="relative group">
                        <img src="${house.img}" alt="${house.name}" class="w-full h-64 object-cover bg-gray-200">
                        <div class="absolute top-0 right-0 bg-yellow-400 text-yellow-900 font-bold px-3 py-1 m-2 rounded-lg shadow-md border-2 border-yellow-200">
                            #${house.id}
                        </div>
                    </div>
                    
                    <div class="p-5">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">${house.name}</h2>
                        
                        <div class="flex items-center justify-between mt-4">
                            <div class="text-gray-600 font-semibold bg-white/50 px-3 py-1 rounded-lg border border-gray-200">
                                <i class="fas fa-heart text-red-500 mr-1"></i> 
                                <span id="count-house-${house.id}" class="text-lg">${voteCount}</span> Votes
                            </div>
                            
                            <button 
                                onclick="castVote(${house.id})" 
                                id="btn-${house.id}"
                                class="btn-vote bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full shadow-lg flex items-center gap-2 ${hasVotedLocal ? 'btn-disabled' : ''}"
                                ${hasVotedLocal ? 'disabled' : ''}
                            >
                                <i class="fas fa-vote-yea"></i> ${hasVotedLocal ? 'Voted' : 'Vote'}
                            </button>
                        </div>
                    </div>
                `;
                
                houseGrid.appendChild(card);
            });
            
            if (hasVotedLocal) checkLocalVoteStatus();
            if (isVotingClosed) disableAllVoting();
        }

        function updateVoteCounts() {
            housesData.forEach(house => {
                const countSpan = document.getElementById(`count-house-${house.id}`);
                if (countSpan) {
                    const count = currentVotes[`house_${house.id}`] || 0;
                    countSpan.innerText = count;
                }
            });
        }

        function disableAllVoting() {
            const buttons = document.querySelectorAll('.btn-vote');
            buttons.forEach(btn => {
                btn.classList.add('btn-disabled');
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-lock"></i> Closed`;
                btn.classList.replace('bg-red-600', 'bg-gray-500');
            });
            votedBanner.classList.add('hidden');
        }

        function revealWinners() {
            // Sort houses by votes
            const sortedHouses = [...housesData].sort((a, b) => {
                const votesA = currentVotes[`house_${a.id}`] || 0;
                const votesB = currentVotes[`house_${b.id}`] || 0;
                return votesB - votesA;
            });

            const first = sortedHouses[0];
            const second = sortedHouses[1];
            
            const firstVotes = currentVotes[`house_${first.id}`] || 0;
            const secondVotes = currentVotes[`house_${second.id}`] || 0;

            // Populate Podium
            if (first) {
                document.getElementById('winner-1-name').innerText = first.name;
                document.getElementById('winner-1-votes').innerText = `${firstVotes} Votes`;
                document.getElementById('winner-1-img').style.backgroundImage = `url('${first.img}')`;
            }
            if (second) {
                document.getElementById('winner-2-name').innerText = second.name;
                document.getElementById('winner-2-votes').innerText = `${secondVotes} Votes`;
                document.getElementById('winner-2-img').style.backgroundImage = `url('${second.img}')`;
            }

            // Show animation
            winnersPodium.classList.add('show');
        }

        // --- VOTING LOGIC ---
        window.castVote = async (houseId) => {
            // 1. Time Check Security
            if (new Date() >= VOTING_DEADLINE) {
                alert("Sorry! The deadline has passed. The elves have stopped counting.");
                return;
            }

            if (!currentUser) {
                alert("Hold on! Still connecting...");
                return;
            }
            if (localStorage.getItem('gingerbread_voted_2025')) {
                alert("You have already voted! One vote per person please. üéÑ");
                return;
            }

            hasVotedLocal = true;
            localStorage.setItem('gingerbread_voted_2025', 'true');
            checkLocalVoteStatus();
            
            const docRef = doc(db, 'gingerbread_votes', `house_${houseId}`);

            try {
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(docRef);
                    if (!sfDoc.exists()) {
                        transaction.set(docRef, { count: 1 });
                    } else {
                        const newCount = (sfDoc.data().count || 0) + 1;
                        transaction.update(docRef, { count: newCount });
                    }
                });
                
                showConfetti();
                
            } catch (e) {
                console.error("Transaction failed: ", e);
                alert("Oh no! The vote got stuck. Please try again.");
                localStorage.removeItem('gingerbread_voted_2025');
                hasVotedLocal = false;
                
                // Re-enable if open
                if (!isVotingClosed) {
                    const buttons = document.querySelectorAll('.btn-vote');
                    buttons.forEach(btn => {
                        btn.classList.remove('btn-disabled');
                        btn.disabled = false;
                        btn.innerHTML = `<i class="fas fa-vote-yea"></i> Vote`;
                    });
                }
            }
        }

        function checkLocalVoteStatus() {
            if (hasVotedLocal && !isVotingClosed) {
                votedBanner.classList.remove('hidden');
                const buttons = document.querySelectorAll('.btn-vote');
                buttons.forEach(btn => {
                    btn.classList.add('btn-disabled');
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-check"></i> Voted`;
                });
            }
        }

        function showConfetti() {
            const celebration = document.createElement('div');
            celebration.style.position = 'fixed';
            celebration.style.top = '50%';
            celebration.style.left = '50%';
            celebration.style.transform = 'translate(-50%, -50%)';
            celebration.style.fontSize = '5rem';
            celebration.style.pointerEvents = 'none';
            celebration.style.zIndex = '9999';
            celebration.innerText = 'üéÖüéâüç™';
            celebration.style.animation = 'ping 1s cubic-bezier(0, 0, 0.2, 1) infinite';
            
            document.body.appendChild(celebration);
            
            setTimeout(() => {
                celebration.remove();
            }, 2000);
        }
    </script>
</body>
</html>